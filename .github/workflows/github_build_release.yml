name: Build Release
on:
  push:
    branches:
      - release
      - pre-release
  pull_request:
    branches:
      - release
      - pre-release
#    tags:
#      - 'v*.*.*'

env:
  go-version: '^1.16.4'
  go-stable: 'true'
  artifact-retention-days: 5

jobs:
  build-and-publish:
    name: Build & Publish (Pre)Release
    runs-on: windows-latest
    if: ${{ !contains(github.event.head_commit.message, '[Skip CI]') }}
    steps:
      # æ‹‰å–é¡¹ç›®ä»£ç 
      - name: Checkout ğŸ”€
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          fetch-depth: 0

      # è·å–Gitä¿¡æ¯
      - name: Get Git Info ğŸ’¡
        shell: pwsh
        run: |
          $GIT_BRANCH=$env:GITHUB_REF -replace 'refs/heads/', ''
          echo "GIT_BRANCH=$GIT_BRANCH" >> $env:GITHUB_ENV
          echo "Current Branch: $GIT_BRANCH"
          $GIT_TAG_LATEST=git tag -l 'v*.*.*' | Sort-Object -Descending -Top 1
          echo "GIT_TAG_LATEST=$GIT_TAG_LATEST" >> $env:GITHUB_ENV
          echo "Latest Tag: $GIT_TAG_LATEST"

      # é…ç½®æ„å»ºä¿¡æ¯
      - name: Configurate Build Information ğŸ–¨
        if: success()
        shell: pwsh
        run: |
          $BUILD_PATH="$pwd\build"
          echo "BUILD_PATH=$BUILD_PATH" >> $env:GITHUB_ENV
          $BUILD_VERSION=cat .\versioninfo.json | jq -r '.StringFileInfo.ProductVersion'
          echo "BUILD_VERSION=$BUILD_VERSION" >> $env:GITHUB_ENV
          echo "Build Version: $BUILD_VERSION"

      # æ„å»ºå‰æ£€æŸ¥
      - name: Check on Failures âŒ
        if: ${{ env.GIT_TAG_LATEST != '' && env.GIT_TAG_LATEST >= env.BUILD_VERSION }}
        shell: pwsh
        run: |
          echo "A newer or the current version already exists."
          echo "Latest Tag: $env:GIT_TAG_LATEST, Build Version: $env:BUILD_VERSION"
          echo "This build has been cancelled."
          exit 1

      # é…ç½®Golangç¯å¢ƒ
      - name: Setup Go Environment ğŸ“
        uses: actions/setup-go@v2
        if: success()
#         with:
#           go-version: ${{ env.go-version }}
#           stable: ${{ env.go-stable }}

      # è·å–ä¾èµ–åŒ…
      - name: Get Go Modules ğŸ“Ÿ
        if: success()
        shell: pwsh
        run: |
          go version
          go env
          mkdir -p .\build

      # è¿è¡ŒGolangæµ‹è¯•
      #  - name: Golang Test âœ…
      #      run: |

      # æ„å»º64ä½åº”ç”¨
      - name: Build x64 Application ğŸ› 
        if: success()
        shell: pwsh
        run: |
          $env:GOOS="windows"
          $env:GOARCH="amd64"
          go build -a -v -x -ldflags "-H=windowsgui -s -w" -o .\build\Clash.Mini_release_x64.exe

      # æ„å»º32ä½åº”ç”¨
      - name: Build x86 Application ğŸ› 
        if: success()
        shell: pwsh
        run: |
          $env:GOOS="windows"
          $env:GOARCH="386"
          go build -a -v -x -ldflags "-H=windowsgui -s -w" -o .\build\Clash.Mini_release_x86.exe

      # å‡†å¤‡å‘å¸ƒPreReleaseæ–‡ä»¶
      - id: prepare-pre-release
        name: Prepare to Publish PreRelease ğŸ•¹
        if: ${{ env.GIT_BRANCH != 'release' && success() }}
        shell: pwsh
        run: |
          cd $env:BUILD_PATH
          mkdir -p .\publish
          $BUILD_X64_FILENAME="Clash.Mini_${env:GIT_BRANCH}_${env:BUILD_VERSION}_x64.exe"
          $BUILD_X86_FILENAME="Clash.Mini_${env:GIT_BRANCH}_${env:BUILD_VERSION}_x86.exe"
          echo "BUILD_X64_FILENAME=$BUILD_X64_FILENAME" >> $env:GITHUB_ENV
          echo "BUILD_X86_FILENAME=$BUILD_X86_FILENAME" >> $env:GITHUB_ENV
          cp .\Clash.Mini_release_*.exe .\publish\
          echo "Ready to upload the following file(s):"
          ls .\publish

      # ä¸Šä¼ 64ä½åº”ç”¨åˆ°Actions Artifacts
      - name: Upload x64 Application to Artifacts ğŸ“¤
        if: ${{ steps.prepare-pre-release.outcome == 'success' }}
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.BUILD_X64_FILENAME }}
          path: ${{ env.BUILD_PATH }}\publish\*_x64.exe
          if-no-files-found: error
          retention-days: ${{ env.artifact-retention-days }}

      # ä¸Šä¼ 32ä½åº”ç”¨åˆ°Actions Artifacts
      - name: Upload x86 Application to Artifacts ğŸ“¤
        if: ${{ steps.prepare-pre-release.outcome == 'success' && success() }}
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.BUILD_X86_FILENAME }}
          path: ${{ env.BUILD_PATH }}\publish\*_x86.exe
          if-no-files-found: error
          retention-days: ${{ env.artifact-retention-days }}

      # å‡†å¤‡å‘å¸ƒReleaseæ–‡ä»¶
      - name: Prepare to Publish Release ğŸ•¹
        if: ${{ env.GIT_BRANCH == 'release' && success() }}
        shell: pwsh
        run: |
          cd $env:BUILD_PATH
          mkdir -p .\publish
          $BUILD_X64_FILENAME="Clash.Mini_${env:BUILD_VERSION}_x64.exe"
          $BUILD_X86_FILENAME="Clash.Mini_${env:BUILD_VERSION}_x86.exe"
          echo "BUILD_X64_FILENAME=$BUILD_X64_FILENAME" >> $env:GITHUB_ENV
          echo "BUILD_X86_FILENAME=$BUILD_X86_FILENAME" >> $env:GITHUB_ENV
          cp .\Clash.Mini_release_*.exe .\publish\
          echo "Ready to upload the following file(s):"
          ls .\publish -Include 'Clash.Mini_release_*.exe' -Recurse | ForEach-Object { Rename-Item $_.FullName $_.FullName.Replace('_release', '') }
          echo "Prepare to compression"
          mkdir -p .\publish\x64
          mkdir -p .\publish\x86
          $packageFiles@("Profile","config.yaml","Country.mmdb")
          mv .\build\publish\Clash.Mini*64.exe .\build\publish\x64\Clash.Mini.exe
          $filesX64=$packageFiles + "publish\Clash.Mini*64.exe"
          foreach ($file in $filesX64){ cp .\$file .\build\publish\x64\ }
          mv .\build\publish\Clash.Mini*86.exe .\build\publish\x86\Clash.Mini.exe
          $filesX86=$packageFiles + "publish\Clash.Mini*86.exe"
          foreach ($file in $filesX86){ cp .\$file .\build\publish\x86\ }

      # å‡†å¤‡64ä½å‹ç¼©åŒ…
      - name: Compression x64 ğŸ“¦
        if: success()
        uses: edgarrc/action-7z@v1
        with:
          args: 7z a -t7z -mx=9 ${{ env.BUILD_VERSION }}.7z .\build\publish\x64\*

      # å‡†å¤‡32ä½å‹ç¼©åŒ…
      - name: Compression x86 ğŸ“¦
        if: success()
        uses: edgarrc/action-7z@v1
        with:
          args: 7z a -t7z -mx=9 ${{ env.BUILD_VERSION }}.7z .\build\publish\x86\*

      # å‘å¸ƒåˆ°Releases
      - name: Publish to Releases ğŸ’¸
        if: success()
        uses: ncipollo/release-action@v1
        with:
          prerelease: ${{ env.GIT_BRANCH != 'release' }}
          tag: ${{ env.BUILD_VERSION }}
          artifacts: ${{ env.BUILD_PATH }}\publish\Clash.Mini*.7z
          #          bodyFile: .\CHANGELOG.md
          bodyFile: .\RELEASELOG.md
          token: ${{ secrets.ACTION_ACCESS_TOKEN }}
